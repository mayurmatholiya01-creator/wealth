<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Stock Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 12px;
      min-height: 100vh;
    }
    
    .dashboard-container {
      max-width: 400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header-title {
      color: white;
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .last-updated {
      color: rgba(255, 255, 255, 0.8);
      font-size: 11px;
      text-align: center;
      margin-top: 8px;
    }

    /* Main Section */
    .top-movers-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 0;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      padding: 20px 20px 16px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-right: auto;
    }
    
    .toggle-buttons {
      display: flex;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 3px;
    }
    
    .toggle-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 9px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      color: white;
    }
    
    .toggle-btn.active {
      background: white;
      color: #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .toggle-btn:not(.active) {
      background: transparent;
    }

    /* Stocks Container with Scroll */
    .stocks-container {
      height: 400px;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding: 0 20px 20px;
    }

    .stocks-container::-webkit-scrollbar {
      display: none;
    }
    
    .stocks-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 16px;
    }
    
    .stock-card {
      background: white;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }

    .stock-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent-color);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .stock-card:hover::before {
      transform: scaleY(1);
    }
    
    .stock-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }

    .stock-card.positive {
      --accent-color: #10b981;
    }

    .stock-card.negative {
      --accent-color: #ef4444;
    }
    
    .stock-info {
      flex: 1;
      margin-right: 12px;
    }
    
    .stock-ticker {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }
    
    .stock-name {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.3;
      font-weight: 500;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .stock-metrics {
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      min-width: 80px;
    }
    
    .stock-price {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      font-variant-numeric: tabular-nums;
    }
    
    .stock-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 8px;
      font-variant-numeric: tabular-nums;
    }
    
    .change-positive {
      color: #059669;
      background: rgba(16, 185, 129, 0.1);
    }
    
    .change-negative {
      color: #dc2626;
      background: rgba(239, 68, 68, 0.1);
    }
    
    .arrow-up::before {
      content: "▲";
      font-size: 10px;
    }
    
    .arrow-down::before {
      content: "▼";
      font-size: 10px;
    }

    /* Loading States */
    .loading-skeleton {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px 20px 20px;
    }

    .skeleton-card {
      background: #f3f4f6;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .skeleton-text {
      background: #e5e7eb;
      border-radius: 4px;
      height: 12px;
    }

    .skeleton-ticker {
      width: 80px;
      height: 16px;
      background: #d1d5db;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .skeleton-name {
      width: 120px;
    }

    .skeleton-price {
      width: 60px;
      height: 16px;
      background: #d1d5db;
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .skeleton-change {
      width: 80px;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.6;
      }
    }

    /* Error States */
    .error {
      text-align: center;
      padding: 40px 20px;
      color: #dc2626;
      font-size: 14px;
      font-weight: 500;
    }

    .error-icon {
      font-size: 32px;
      margin-bottom: 12px;
      display: block;
    }

    /* Scroll Indicator */
    .scroll-indicator {
      position: absolute;
      bottom: 20px;
      right: 20px;
      color: #9ca3af;
      font-size: 10px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.8);
      padding: 4px 8px;
      border-radius: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .scroll-indicator.show {
      opacity: 1;
    }

    /* Update Indicator */
    .update-indicator {
      position: absolute;
      top: 10px;
      right: 20px;
      background: rgba(16, 185, 129, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .update-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Responsive */
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .header {
        padding: 12px;
        border-radius: 16px;
      }

      .header-title {
        font-size: 20px;
      }

      .top-movers-section {
        border-radius: 16px;
      }
      
      .section-header {
        padding: 16px 16px 12px;
      }

      .section-title {
        font-size: 16px;
      }
      
      .toggle-btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .stocks-container {
        padding: 0 16px 16px;
        height: 420px;
      }
      
      .stock-card {
        padding: 14px;
        border-radius: 14px;
      }
      
      .stock-ticker {
        font-size: 15px;
      }
      
      .stock-name {
        font-size: 11px;
      }
      
      .stock-price {
        font-size: 15px;
      }

      .stock-change {
        font-size: 11px;
        padding: 3px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <div class="header">
      <h1 class="header-title">Stock Watch</h1>
      <div class="last-updated" id="last-updated"></div>
    </div>

    <!-- Main Section -->
    <div class="top-movers-section">
      <div class="section-header">
        <h2 class="section-title">Top Movers</h2>
        <div class="toggle-buttons">
          <button class="toggle-btn active" id="gainers-btn">Gainers</button>
          <button class="toggle-btn" id="losers-btn">Losers</button>
        </div>
      </div>
      
      <div class="stocks-container" id="stocks-container">
        <div class="stocks-list" id="stocks-list">
          <!-- Loading Skeleton -->
          <div class="loading-skeleton" id="loading-skeleton">
            <div class="skeleton-card">
              <div>
                <div class="skeleton-ticker"></div>
                <div class="skeleton-text skeleton-name"></div>
              </div>
              <div>
                <div class="skeleton-price"></div>
                <div class="skeleton-text skeleton-change"></div>
              </div>
            </div>
            <div class="skeleton-card">
              <div>
                <div class="skeleton-ticker"></div>
                <div class="skeleton-text skeleton-name"></div>
              </div>
              <div>
                <div class="skeleton-price"></div>
                <div class="skeleton-text skeleton-change"></div>
              </div>
            </div>
            <div class="skeleton-card">
              <div>
                <div class="skeleton-ticker"></div>
                <div class="skeleton-text skeleton-name"></div>
              </div>
              <div>
                <div class="skeleton-price"></div>
                <div class="skeleton-text skeleton-change"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="scroll-indicator" id="scroll-indicator">Scroll for more</div>
      </div>

      <div class="update-indicator" id="update-indicator">Updated</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQm1ArLE54YU7jUSm-2TH5x8dsaYTgMqPmLH6jruV00s4WNAGrML1ozXSPsM_71BPZTMKJijsgsEeEk/pub?gid=1581897548&single=true&output=csv';
    
    let stockData = [];
    let currentView = 'gainers';
    let isLoading = false;
    let cachedData = null;
    let lastUpdateTime = null;
    
    // DOM Elements
    const gainersBtn = document.getElementById('gainers-btn');
    const losersBtn = document.getElementById('losers-btn');
    const stocksList = document.getElementById('stocks-list');
    const stocksContainer = document.getElementById('stocks-container');
    const lastUpdated = document.getElementById('last-updated');
    const loadingSkeleton = document.getElementById('loading-skeleton');
    const scrollIndicator = document.getElementById('scroll-indicator');
    const updateIndicator = document.getElementById('update-indicator');
    
    // Cache management
    function getCachedData() {
      try {
        const cached = localStorage.getItem('stockData');
        const cacheTime = localStorage.getItem('stockDataTime');
        if (cached && cacheTime) {
          const age = Date.now() - parseInt(cacheTime);
          if (age < 5 * 60 * 1000) { // 5 minutes cache
            return JSON.parse(cached);
          }
        }
      } catch (e) {
        console.log('Cache error:', e);
      }
      return null;
    }

    function setCachedData(data) {
      try {
        localStorage.setItem('stockData', JSON.stringify(data));
        localStorage.setItem('stockDataTime', Date.now().toString());
      } catch (e) {
        console.log('Cache save error:', e);
      }
    }

    function showUpdateIndicator() {
      updateIndicator.classList.add('show');
      setTimeout(() => {
        updateIndicator.classList.remove('show');
      }, 2000);
    }

    function loadData(showIndicator = false) {
      if (isLoading) return;
      
      // Try cache first for instant load
      const cached = getCachedData();
      if (cached && stockData.length === 0) {
        stockData = cached;
        renderStocks();
        updateLastUpdatedTime();
      }
      
      isLoading = true;
      
      Papa.parse(CSV_URL, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
          try {
            const rows = results.data;
            
            if (rows.length < 3) {
              throw new Error('Insufficient data rows');
            }
            
            const dataRows = rows.slice(2);
            
            const newData = dataRows.map(row => {
              if (!row[0] || row[0].toString().trim() === '') return null;
              
              const ticker = row[0] ? row[0].toString().trim() : '';
              const name = row[2] ? row[2].toString().trim() : '';
              const ltp = row[9] ? row[9].toString().trim() : '0';
              const change = row[10] ? row[10].toString().trim() : '0';
              const changePct = row[11] ? row[11].toString().trim() : '0%';
              
              return {
                ticker: ticker,
                name: name,
                ltp: parseFloat(ltp) || 0,
                change: parseFloat(change) || 0,
                changePct: changePct,
                ltpFormatted: ltp,
                changeFormatted: change
              };
            }).filter(stock => stock && stock.ticker && stock.ltp > 0);
            
            // Only update if data actually changed
            if (JSON.stringify(newData) !== JSON.stringify(stockData)) {
              stockData = newData;
              setCachedData(stockData);
              renderStocks();
              if (showIndicator) showUpdateIndicator();
            }
            
            updateLastUpdatedTime();
            isLoading = false;
            
          } catch (error) {
            console.error('Error processing data:', error);
            if (stockData.length === 0) {
              showError('Error loading data. Please refresh.');
            }
            isLoading = false;
          }
        },
        error: function(error) {
          console.error('Error loading CSV:', error);
          if (stockData.length === 0) {
            showError('Failed to load data. Check connection.');
          }
          isLoading = false;
        }
      });
    }

    function updateLastUpdatedTime() {
      const now = new Date();
      lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString('en-IN', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      })}`;
      lastUpdateTime = now;
    }
    
    function showError(message) {
      stocksList.innerHTML = `
        <div class="error">
          <span class="error-icon">⚠️</span>
          ${message}
        </div>
      `;
    }
    
    function renderStocks() {
      loadingSkeleton.style.display = 'none';
      
      if (stockData.length === 0) {
        showError('No stock data available');
        return;
      }
      
      let filteredData = [...stockData];
      
      if (currentView === 'gainers') {
        filteredData = filteredData.filter(stock => stock.change > 0)
                                   .sort((a, b) => b.change - a.change);
      } else {
        filteredData = filteredData.filter(stock => stock.change < 0)
                                   .sort((a, b) => a.change - b.change);
      }
      
      if (filteredData.length === 0) {
        showError(`No ${currentView} found`);
        return;
      }

      // Show scroll indicator if more than 5 items
      if (filteredData.length > 5) {
        scrollIndicator.classList.add('show');
        setTimeout(() => scrollIndicator.classList.remove('show'), 3000);
      }
      
      const stocksHTML = filteredData.map(stock => {
        const isPositive = stock.change > 0;
        const changeClass = isPositive ? 'change-positive' : 'change-negative';
        const cardClass = isPositive ? 'positive' : 'negative';
        const arrowClass = isPositive ? 'arrow-up' : 'arrow-down';
        
        let percentDisplay = stock.changePct;
        if (percentDisplay.includes('%')) {
          percentDisplay = percentDisplay.replace('-', '');
        }
        
        return `
          <div class="stock-card ${cardClass}">
            <div class="stock-info">
              <div class="stock-ticker">${stock.ticker}</div>
              <div class="stock-name">${stock.name}</div>
            </div>
            <div class="stock-metrics">
              <div class="stock-price">₹${parseFloat(stock.ltpFormatted).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <div class="stock-change ${changeClass}">
                <span class="${arrowClass}"></span>
                ${Math.abs(stock.change).toFixed(2)} (${percentDisplay})
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      stocksList.innerHTML = stocksHTML;
      
      // Reset scroll position when switching views
      stocksContainer.scrollTop = 0;
    }
    
    // Event Listeners
    gainersBtn.addEventListener('click', () => {
      if (currentView !== 'gainers') {
        currentView = 'gainers';
        gainersBtn.classList.add('active');
        losersBtn.classList.remove('active');
        renderStocks();
      }
    });
    
    losersBtn.addEventListener('click', () => {
      if (currentView !== 'losers') {
        currentView = 'losers';
        losersBtn.classList.add('active');
        gainersBtn.classList.remove('active');
        renderStocks();
      }
    });

    // Scroll handling
    stocksContainer.addEventListener('scroll', () => {
      const { scrollTop, scrollHeight, clientHeight } = stocksContainer;
      const scrollPercent = (scrollTop / (scrollHeight - clientHeight)) * 100;
      
      if (scrollPercent > 10 && scrollPercent < 90) {
        scrollIndicator.classList.remove('show');
      }
    });
    
    // Initialize
    loadData();
    
    // Smart refresh - only every 2 minutes, and not if user is actively scrolling
    let refreshTimer;
    let lastScrollTime = 0;
    
    stocksContainer.addEventListener('scroll', () => {
      lastScrollTime = Date.now();
    });
    
    function smartRefresh() {
      const timeSinceScroll = Date.now() - lastScrollTime;
      const timeSinceUpdate = lastUpdateTime ? Date.now() - lastUpdateTime.getTime() : Infinity;
      
      // Only refresh if user hasn't scrolled in 10 seconds and it's been at least 2 minutes
      if (timeSinceScroll > 10000 && timeSinceUpdate > 120000) {
        loadData(true);
      }
    }
    
    // Set smart refresh interval
    setInterval(smartRefresh, 30000);
    
    // Refresh on page focus
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        const timeSinceUpdate = lastUpdateTime ? Date.now() - lastUpdateTime.getTime() : Infinity;
        if (timeSinceUpdate > 60000) { // 1 minute
          loadData(true);
        }
      }
    });
  </script>
</body>
</html>
