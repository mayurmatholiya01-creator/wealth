<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: #0f172a;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 12px;
      min-height: 100vh;
      color: #e2e8f0;
    }
    
    .dashboard-container {
      max-width: 400px;
      margin: 0 auto;
    }

    /* Main Section */
    .top-movers-section {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      border: 1px solid rgba(71, 85, 105, 0.3);
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-right: auto;
      color: #f1f5f9;
    }
    
    .toggle-buttons {
      display: flex;
      background: rgba(51, 65, 85, 0.4);
      border-radius: 10px;
      padding: 2px;
      border: 1px solid rgba(71, 85, 105, 0.3);
    }
    
    .toggle-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #94a3b8;
      background: transparent;
    }
    
    .toggle-btn.active {
      background: rgba(59, 130, 246, 0.8);
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
    }

    /* Stocks Container */
    .stocks-container {
      height: 480px;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding: 0;
    }

    .stocks-container::-webkit-scrollbar {
      display: none;
    }
    
    .stocks-list {
      display: flex;
      flex-direction: column;
    }
    
    .stock-card {
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(4px);
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(71, 85, 105, 0.15);
      position: relative;
    }

    .stock-card:hover {
      background: rgba(30, 41, 59, 0.6);
      transform: translateX(2px);
    }

    .stock-card.positive {
      border-left: 3px solid #10b981;
    }

    .stock-card.negative {
      border-left: 3px solid #ef4444;
    }

    .stock-card.neutral {
      border-left: 3px solid #6b7280;
    }
    
    .stock-info {
      flex: 1;
      margin-right: 12px;
    }
    
    .stock-ticker {
      font-size: 14px;
      font-weight: 700;
      color: #f8fafc;
      margin-bottom: 2px;
      letter-spacing: -0.01em;
    }
    
    .stock-name {
      font-size: 11px;
      color: #94a3b8;
      line-height: 1.3;
      font-weight: 400;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .stock-metrics {
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      min-width: 90px;
    }
    
    .stock-price {
      font-size: 14px;
      font-weight: 600;
      color: #f8fafc;
      font-variant-numeric: tabular-nums;
    }
    
    .stock-change {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      font-variant-numeric: tabular-nums;
    }
    
    .change-positive {
      color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }
    
    .change-negative {
      color: #f87171;
      background: rgba(248, 113, 113, 0.1);
    }

    .change-neutral {
      color: #9ca3af;
      background: rgba(156, 163, 175, 0.1);
    }
    
    .arrow-up::before {
      content: "▲";
      font-size: 8px;
    }
    
    .arrow-down::before {
      content: "▼";
      font-size: 8px;
    }

    .arrow-neutral::before {
      content: "●";
      font-size: 8px;
    }

    /* Performance-based row coloring */
    .stock-card.high-gain {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.08) 0%, rgba(30, 41, 59, 0.4) 30%);
    }

    .stock-card.medium-gain {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.04) 0%, rgba(30, 41, 59, 0.4) 30%);
    }

    .stock-card.high-loss {
      background: linear-gradient(90deg, rgba(248, 113, 113, 0.08) 0%, rgba(30, 41, 59, 0.4) 30%);
    }

    .stock-card.medium-loss {
      background: linear-gradient(90deg, rgba(248, 113, 113, 0.04) 0%, rgba(30, 41, 59, 0.4) 30%);
    }

    /* Loading States */
    .loading-skeleton {
      display: flex;
      flex-direction: column;
    }

    .skeleton-card {
      background: rgba(30, 41, 59, 0.4);
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: pulse 1.5s ease-in-out infinite;
      border-bottom: 1px solid rgba(71, 85, 105, 0.15);
    }

    .skeleton-text {
      background: rgba(71, 85, 105, 0.4);
      border-radius: 4px;
      height: 12px;
    }

    .skeleton-ticker {
      width: 60px;
      height: 14px;
      background: rgba(71, 85, 105, 0.5);
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .skeleton-name {
      width: 100px;
    }

    .skeleton-price {
      width: 50px;
      height: 14px;
      background: rgba(71, 85, 105, 0.5);
      border-radius: 4px;
      margin-bottom: 2px;
    }

    .skeleton-change {
      width: 70px;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.4;
      }
    }

    /* Error States */
    .error {
      text-align: center;
      padding: 40px 20px;
      color: #f87171;
      font-size: 13px;
      font-weight: 500;
    }

    .error-icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }

    /* Update Indicator */
    .update-indicator {
      position: absolute;
      top: 16px;
      right: 20px;
      background: rgba(34, 197, 94, 0.9);
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.3s ease;
    }

    .update-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Last Updated */
    .last-updated {
      color: #64748b;
      font-size: 10px;
      text-align: center;
      padding: 8px;
      background: rgba(30, 41, 59, 0.3);
    }

    /* Responsive */
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .top-movers-section {
        border-radius: 14px;
      }
      
      .section-header {
        padding: 14px 16px;
      }

      .section-title {
        font-size: 15px;
      }
      
      .toggle-btn {
        padding: 5px 10px;
        font-size: 11px;
      }

      .stocks-container {
        height: 500px;
      }
      
      .stock-card {
        padding: 12px 16px;
      }
      
      .stock-ticker {
        font-size: 13px;
      }
      
      .stock-name {
        font-size: 10px;
      }
      
      .stock-price {
        font-size: 13px;
      }

      .stock-change {
        font-size: 10px;
        padding: 2px 5px;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Main Section -->
    <div class="top-movers-section">
      <div class="section-header">
        <h2 class="section-title">Top Movers</h2>
        <div class="toggle-buttons">
          <button class="toggle-btn active" id="gainers-btn">Gainers</button>
          <button class="toggle-btn" id="losers-btn">Losers</button>
        </div>
      </div>
      
      <div class="stocks-container" id="stocks-container">
        <div class="stocks-list" id="stocks-list">
          <!-- Loading Skeleton -->
          <div class="loading-skeleton" id="loading-skeleton">
            <div class="skeleton-card">
              <div>
                <div class="skeleton-ticker"></div>
                <div class="skeleton-text skeleton-name"></div>
              </div>
              <div>
                <div class="skeleton-price"></div>
                <div class="skeleton-text skeleton-change"></div>
              </div>
            </div>
            <div class="skeleton-card">
              <div>
                <div class="skeleton-ticker"></div>
                <div class="skeleton-text skeleton-name"></div>
              </div>
              <div>
                <div class="skeleton-price"></div>
                <div class="skeleton-text skeleton-change"></div>
              </div>
            </div>
            <div class="skeleton-card">
              <div>
                <div class="skeleton-ticker"></div>
                <div class="skeleton-text skeleton-name"></div>
              </div>
              <div>
                <div class="skeleton-price"></div>
                <div class="skeleton-text skeleton-change"></div>
              </div>
            </div>
            <div class="skeleton-card">
              <div>
                <div class="skeleton-ticker"></div>
                <div class="skeleton-text skeleton-name"></div>
              </div>
              <div>
                <div class="skeleton-price"></div>
                <div class="skeleton-text skeleton-change"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="last-updated" id="last-updated"></div>
      <div class="update-indicator" id="update-indicator">Updated</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQm1ArLE54YU7jUSm-2TH5x8dsaYTgMqPmLH6jruV00s4WNAGrML1ozXSPsM_71BPZTMKJijsgsEeEk/pub?gid=1581897548&single=true&output=csv';
    
    let stockData = [];
    let currentView = 'gainers';
    let isLoading = false;
    let lastUpdateTime = null;
    
    // DOM Elements
    const gainersBtn = document.getElementById('gainers-btn');
    const losersBtn = document.getElementById('losers-btn');
    const stocksList = document.getElementById('stocks-list');
    const stocksContainer = document.getElementById('stocks-container');
    const lastUpdated = document.getElementById('last-updated');
    const loadingSkeleton = document.getElementById('loading-skeleton');
    const updateIndicator = document.getElementById('update-indicator');
    
    // Cache management
    function getCachedData() {
      try {
        const cached = localStorage.getItem('stockData');
        const cacheTime = localStorage.getItem('stockDataTime');
        if (cached && cacheTime) {
          const age = Date.now() - parseInt(cacheTime);
          if (age < 5 * 60 * 1000) {
            return JSON.parse(cached);
          }
        }
      } catch (e) {
        console.log('Cache error:', e);
      }
      return null;
    }

    function setCachedData(data) {
      try {
        localStorage.setItem('stockData', JSON.stringify(data));
        localStorage.setItem('stockDataTime', Date.now().toString());
      } catch (e) {
        console.log('Cache save error:', e);
      }
    }

    function showUpdateIndicator() {
      updateIndicator.classList.add('show');
      setTimeout(() => {
        updateIndicator.classList.remove('show');
      }, 2000);
    }

    function getPerformanceClass(changePct) {
      const pct = Math.abs(parseFloat(changePct.replace('%', '')));
      
      if (changePct.includes('-')) {
        if (pct >= 5) return 'high-loss';
        if (pct >= 2) return 'medium-loss';
        return '';
      } else {
        if (pct >= 5) return 'high-gain';
        if (pct >= 2) return 'medium-gain';
        return '';
      }
    }

    function loadData(showIndicator = false) {
      if (isLoading) return;
      
      const cached = getCachedData();
      if (cached && stockData.length === 0) {
        stockData = cached;
        renderStocks();
        updateLastUpdatedTime();
      }
      
      isLoading = true;
      
      Papa.parse(CSV_URL, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
          try {
            const rows = results.data;
            
            if (rows.length < 3) {
              throw new Error('Insufficient data rows');
            }
            
            const dataRows = rows.slice(2);
            
            const newData = dataRows.map(row => {
              if (!row[0] || row[0].toString().trim() === '') return null;
              
              const ticker = row[0] ? row[0].toString().trim() : '';
              const name = row[2] ? row[2].toString().trim() : '';
              const ltp = row[9] ? row[9].toString().trim() : '0';
              const change = row[10] ? row[10].toString().trim() : '0';
              const changePct = row[11] ? row[11].toString().trim() : '0%';
              
              return {
                ticker: ticker,
                name: name,
                ltp: parseFloat(ltp) || 0,
                change: parseFloat(change) || 0,
                changePct: changePct,
                ltpFormatted: ltp,
                changeFormatted: change
              };
            }).filter(stock => stock && stock.ticker && stock.ltp > 0);
            
            if (JSON.stringify(newData) !== JSON.stringify(stockData)) {
              stockData = newData;
              setCachedData(stockData);
              renderStocks();
              if (showIndicator) showUpdateIndicator();
            }
            
            updateLastUpdatedTime();
            isLoading = false;
            
          } catch (error) {
            console.error('Error processing data:', error);
            if (stockData.length === 0) {
              showError('Error loading data. Please refresh.');
            }
            isLoading = false;
          }
        },
        error: function(error) {
          console.error('Error loading CSV:', error);
          if (stockData.length === 0) {
            showError('Failed to load data. Check connection.');
          }
          isLoading = false;
        }
      });
    }

    function updateLastUpdatedTime() {
      const now = new Date();
      lastUpdated.textContent = `Updated ${now.toLocaleTimeString('en-IN', { 
        hour: '2-digit', 
        minute: '2-digit'
      })}`;
      lastUpdateTime = now;
    }
    
    function showError(message) {
      stocksList.innerHTML = `
        <div class="error">
          <span class="error-icon">⚠️</span>
          ${message}
        </div>
      `;
    }
    
    function renderStocks() {
      loadingSkeleton.style.display = 'none';
      
      if (stockData.length === 0) {
        showError('No stock data available');
        return;
      }
      
      let filteredData = [...stockData];
      
      if (currentView === 'gainers') {
        filteredData = filteredData.filter(stock => stock.change > 0)
                                   .sort((a, b) => {
                                     const aPercent = parseFloat(a.changePct.replace('%', ''));
                                     const bPercent = parseFloat(b.changePct.replace('%', ''));
                                     return bPercent - aPercent;
                                   });
      } else {
        filteredData = filteredData.filter(stock => stock.change < 0)
                                   .sort((a, b) => {
                                     const aPercent = parseFloat(a.changePct.replace('%', ''));
                                     const bPercent = parseFloat(b.changePct.replace('%', ''));
                                     return aPercent - bPercent;
                                   });
      }
      
      if (filteredData.length === 0) {
        showError(`No ${currentView} found`);
        return;
      }
      
      const stocksHTML = filteredData.map(stock => {
        const change = stock.change;
        let changeClass, cardClass, arrowClass;
        
        if (change > 0) {
          changeClass = 'change-positive';
          cardClass = 'positive';
          arrowClass = 'arrow-up';
        } else if (change < 0) {
          changeClass = 'change-negative';
          cardClass = 'negative';
          arrowClass = 'arrow-down';
        } else {
          changeClass = 'change-neutral';
          cardClass = 'neutral';
          arrowClass = 'arrow-neutral';
        }

        const performanceClass = getPerformanceClass(stock.changePct);
        
        let percentDisplay = stock.changePct;
        if (percentDisplay.includes('%')) {
          percentDisplay = percentDisplay.replace('-', '');
        }
        
        return `
          <div class="stock-card ${cardClass} ${performanceClass}">
            <div class="stock-info">
              <div class="stock-ticker">${stock.ticker}</div>
              <div class="stock-name">${stock.name}</div>
            </div>
            <div class="stock-metrics">
              <div class="stock-price">₹${parseFloat(stock.ltpFormatted).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <div class="stock-change ${changeClass}">
                <span class="${arrowClass}"></span>
                ${Math.abs(stock.change).toFixed(2)} (${percentDisplay})
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      stocksList.innerHTML = stocksHTML;
      stocksContainer.scrollTop = 0;
    }
    
    // Event Listeners
    gainersBtn.addEventListener('click', () => {
      if (currentView !== 'gainers') {
        currentView = 'gainers';
        gainersBtn.classList.add('active');
        losersBtn.classList.remove('active');
        renderStocks();
      }
    });
    
    losersBtn.addEventListener('click', () => {
      if (currentView !== 'losers') {
        currentView = 'losers';
        losersBtn.classList.add('active');
        gainersBtn.classList.remove('active');
        renderStocks();
      }
    });
    
    // Initialize
    loadData();
    
    // Smart refresh
    let lastScrollTime = 0;
    
    stocksContainer.addEventListener('scroll', () => {
      lastScrollTime = Date.now();
    });
    
    function smartRefresh() {
      const timeSinceScroll = Date.now() - lastScrollTime;
      const timeSinceUpdate = lastUpdateTime ? Date.now() - lastUpdateTime.getTime() : Infinity;
      
      if (timeSinceScroll > 10000 && timeSinceUpdate > 120000) {
        loadData(true);
      }
    }
    
    setInterval(smartRefresh, 30000);
    
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        const timeSinceUpdate = lastUpdateTime ? Date.now() - lastUpdateTime.getTime() : Infinity;
        if (timeSinceUpdate > 60000) {
          loadData(true);
        }
      }
    });
  </script>
</body>
</html>
