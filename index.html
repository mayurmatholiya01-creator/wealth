<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pro Stock Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Animated Background Elements */
    .background-shapes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .shape {
      position: absolute;
      border-radius: 50%;
      opacity: 0.1;
      animation: float 20s ease-in-out infinite;
    }

    .shape-1 {
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 70%);
      top: -150px;
      right: -150px;
      animation-delay: 0s;
    }

    .shape-2 {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(59,130,246,0.4) 0%, rgba(59,130,246,0.1) 70%);
      bottom: -100px;
      left: -100px;
      animation-delay: 7s;
    }

    .shape-3 {
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(147,51,234,0.3) 0%, rgba(147,51,234,0.1) 70%);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation-delay: 14s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-30px) rotate(120deg); }
      66% { transform: translateY(20px) rotate(240deg); }
    }

    /* Main Container */
    .dashboard-container {
      position: relative;
      z-index: 1;
      max-width: 420px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }

    /* Glass Card */
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
    }

    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    }

    /* Header */
    .header {
      padding: 24px 24px 20px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .title {
      color: white;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    /* Toggle Buttons */
    .toggle-container {
      display: flex;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 4px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .toggle-btn {
      flex: 1;
      background: transparent;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .toggle-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .toggle-btn:hover::before {
      opacity: 1;
    }

    .toggle-btn.active {
      background: linear-gradient(135deg, rgba(59,130,246,0.8), rgba(147,51,234,0.6));
      color: white;
      box-shadow: 0 8px 25px rgba(59,130,246,0.4);
      transform: translateY(-1px);
    }

    .toggle-btn.active::before {
      opacity: 0;
    }

    /* Stocks Container */
    .stocks-container {
      height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .stocks-container::-webkit-scrollbar {
      display: none;
    }

    .stocks-list {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Stock Cards */
    .stock-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(15px);
      border-radius: 18px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .stock-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stock-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .stock-card:hover::before {
      opacity: 1;
    }

    .stock-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
    }

    .stock-info {
      flex: 1;
    }

    .stock-ticker {
      color: white;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }

    .stock-name {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      font-weight: 400;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .stock-metrics {
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .stock-price {
      color: white;
      font-size: 16px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .stock-change {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 12px;
      font-variant-numeric: tabular-nums;
      backdrop-filter: blur(10px);
    }

    .change-positive {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .change-negative {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .change-icon {
      font-size: 10px;
    }

    /* Loading Skeleton */
    .loading-skeleton {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }

    .skeleton-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(15px);
      border-radius: 18px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: pulse 2s ease-in-out infinite;
    }

    .skeleton-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .skeleton-bar {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      animation: shimmer 2s ease-in-out infinite;
    }

    .skeleton-ticker {
      width: 80px;
      height: 16px;
      margin-bottom: 8px;
    }

    .skeleton-name {
      width: 140px;
      height: 12px;
    }

    .skeleton-price {
      width: 70px;
      height: 16px;
      margin-bottom: 8px;
    }

    .skeleton-change {
      width: 90px;
      height: 12px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: calc(200px + 100%) 0; }
    }

    /* Update Indicator */
    .update-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(34, 197, 94, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.3);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 10;
    }

    .update-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Footer */
    .footer {
      padding: 16px 24px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .last-updated {
      color: rgba(255, 255, 255, 0.6);
      font-size: 11px;
      font-weight: 500;
    }

    /* Error State */
    .error-state {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.7);
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .error-message {
      font-size: 14px;
      font-weight: 500;
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      .dashboard-container {
        padding: 12px;
      }

      .glass-card {
        border-radius: 20px;
      }

      .header {
        padding: 20px 20px 16px;
      }

      .title {
        font-size: 18px;
        margin-bottom: 16px;
      }

      .toggle-btn {
        padding: 10px 14px;
        font-size: 13px;
      }

      .stocks-container {
        height: 460px;
      }

      .stocks-list {
        padding: 12px;
        gap: 10px;
      }

      .stock-card {
        padding: 16px;
        border-radius: 16px;
      }

      .stock-ticker {
        font-size: 15px;
      }

      .stock-name {
        font-size: 11px;
      }

      .stock-price {
        font-size: 15px;
      }

      .stock-change {
        font-size: 11px;
        padding: 5px 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="background-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <!-- Main Dashboard -->
  <div class="dashboard-container">
    <div class="glass-card">
      <!-- Header -->
      <div class="header">
        <h1 class="title">Stock Dashboard</h1>
        <div class="toggle-container">
          <button class="toggle-btn active" id="gainers-btn">
            📈 Top Gainers
          </button>
          <button class="toggle-btn" id="losers-btn">
            📉 Top Losers
          </button>
        </div>
      </div>

      <!-- Stocks Container -->
      <div class="stocks-container" id="stocks-container">
        <div class="stocks-list" id="stocks-list">
          <!-- Loading Skeleton -->
          <div class="loading-skeleton" id="loading-skeleton">
            <div class="skeleton-card">
              <div class="skeleton-content">
                <div>
                  <div class="skeleton-bar skeleton-ticker"></div>
                  <div class="skeleton-bar skeleton-name"></div>
                </div>
                <div>
                  <div class="skeleton-bar skeleton-price"></div>
                  <div class="skeleton-bar skeleton-change"></div>
                </div>
              </div>
            </div>
            <div class="skeleton-card">
              <div class="skeleton-content">
                <div>
                  <div class="skeleton-bar skeleton-ticker"></div>
                  <div class="skeleton-bar skeleton-name"></div>
                </div>
                <div>
                  <div class="skeleton-bar skeleton-price"></div>
                  <div class="skeleton-bar skeleton-change"></div>
                </div>
              </div>
            </div>
            <div class="skeleton-card">
              <div class="skeleton-content">
                <div>
                  <div class="skeleton-bar skeleton-ticker"></div>
                  <div class="skeleton-bar skeleton-name"></div>
                </div>
                <div>
                  <div class="skeleton-bar skeleton-price"></div>
                  <div class="skeleton-bar skeleton-change"></div>
                </div>
              </div>
            </div>
            <div class="skeleton-card">
              <div class="skeleton-content">
                <div>
                  <div class="skeleton-bar skeleton-ticker"></div>
                  <div class="skeleton-bar skeleton-name"></div>
                </div>
                <div>
                  <div class="skeleton-bar skeleton-price"></div>
                  <div class="skeleton-bar skeleton-change"></div>
                </div>
              </div>
            </div>
            <div class="skeleton-card">
              <div class="skeleton-content">
                <div>
                  <div class="skeleton-bar skeleton-ticker"></div>
                  <div class="skeleton-bar skeleton-name"></div>
                </div>
                <div>
                  <div class="skeleton-bar skeleton-price"></div>
                  <div class="skeleton-bar skeleton-change"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <div class="last-updated" id="last-updated"></div>
      </div>

      <!-- Update Indicator -->
      <div class="update-indicator" id="update-indicator">Updated ✨</div>
    </div>
  </div>

  <!-- Papa Parse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Main JavaScript -->
  <script>
    class ProStockDashboard {
      constructor() {
        this.csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQm1ArLE54YU7jUSm-2TH5x8dsaYTgMqPmLH6jruV00s4WNAGrML1ozXSPsM_71BPZTMKJijsgsEeEk/pub?gid=1581897548&single=true&output=csv';
        this.stockData = [];
        this.currentView = 'gainers';
        this.isLoading = false;
        this.lastUpdateTime = null;
        this.visibleStockCount = 5;
        
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadCachedData();
        this.fetchData();
        this.startAutoRefresh();
      }

      setupEventListeners() {
        const gainersBtn = document.getElementById('gainers-btn');
        const losersBtn = document.getElementById('losers-btn');
        
        gainersBtn.addEventListener('click', () => this.switchView('gainers'));
        losersBtn.addEventListener('click', () => this.switchView('losers'));

        // Smooth scroll handling
        const stocksContainer = document.getElementById('stocks-container');
        let isScrolling;
        stocksContainer.addEventListener('scroll', () => {
          window.clearTimeout(isScrolling);
          isScrolling = setTimeout(() => {
            // Handle scroll end
          }, 66);
        });
      }

      loadCachedData() {
        try {
          const cached = localStorage.getItem('pro_stock_data');
          const cacheTime = localStorage.getItem('pro_stock_time');
          
          if (cached && cacheTime) {
            const age = Date.now() - parseInt(cacheTime);
            if (age < 5 * 60 * 1000) { // 5 minutes cache
              this.stockData = JSON.parse(cached);
              this.renderStocks();
              this.updateTimestamp();
            }
          }
        } catch (error) {
          console.log('Cache load error:', error);
        }
      }

      saveToCache(data) {
        try {
          localStorage.setItem('pro_stock_data', JSON.stringify(data));
          localStorage.setItem('pro_stock_time', Date.now().toString());
        } catch (error) {
          console.log('Cache save error:', error);
        }
      }

      async fetchData(showUpdateIndicator = false) {
        if (this.isLoading) return;
        
        this.isLoading = true;
        
        try {
          const response = await fetch(this.csvUrl);
          const csvText = await response.text();
          const newData = this.parseCSV(csvText);
          
          if (JSON.stringify(newData) !== JSON.stringify(this.stockData)) {
            this.stockData = newData;
            this.saveToCache(newData);
            this.renderStocks();
            
            if (showUpdateIndicator) {
              this.showUpdateIndicator();
            }
          }
          
          this.updateTimestamp();
          
        } catch (error) {
          console.error('Data fetch error:', error);
          if (this.stockData.length === 0) {
            this.showError();
          }
        } finally {
          this.isLoading = false;
        }
      }

      parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length < 3) return [];
        
        // Skip first 2 header rows, start from row 3 (index 2)
        const dataRows = lines.slice(2);
        
        return dataRows.map(line => {
          const values = this.parseCSVLine(line);
          
          if (!values[0] || values[0].trim() === '') return null;
          
          const ticker = values[0] ? values[0].trim() : '';
          const name = values[2] ? values[2].trim() : '';
          const ltp = values[9] ? parseFloat(values[9]) || 0 : 0;
          const change = values[10] ? parseFloat(values[10]) || 0 : 0;
          const changePct = values[11] ? values[11].trim() : '0%';
          
          return {
            ticker,
            name,
            ltp,
            change,
            changePct,
            ltpFormatted: values[9] ? values[9].trim() : '0'
          };
        }).filter(stock => stock && stock.ticker && stock.ltp > 0);
      }

      parseCSVLine(line) {
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current);
        
        return values;
      }

      switchView(view) {
        if (this.currentView === view) return;
        
        this.currentView = view;
        
        // Update button states
        const gainersBtn = document.getElementById('gainers-btn');
        const losersBtn = document.getElementById('losers-btn');
        
        gainersBtn.classList.toggle('active', view === 'gainers');
        losersBtn.classList.toggle('active', view === 'losers');
        
        this.renderStocks();
      }

      renderStocks() {
        const stocksList = document.getElementById('stocks-list');
        const loadingSkeleton = document.getElementById('loading-skeleton');
        
        if (this.stockData.length === 0) {
          loadingSkeleton.style.display = 'flex';
          return;
        }
        
        loadingSkeleton.style.display = 'none';
        
        let filteredData = [...this.stockData];
        
        if (this.currentView === 'gainers') {
          filteredData = filteredData
            .filter(stock => stock.change > 0)
            .sort((a, b) => {
              const aPercent = parseFloat(a.changePct.replace('%', ''));
              const bPercent = parseFloat(b.changePct.replace('%', ''));
              return bPercent - aPercent;
            });
        } else {
          filteredData = filteredData
            .filter(stock => stock.change < 0)
            .sort((a, b) => {
              const aPercent = parseFloat(a.changePct.replace('%', ''));
              const bPercent = parseFloat(b.changePct.replace('%', ''));
              return aPercent - bPercent;
            });
        }
        
        if (filteredData.length === 0) {
          stocksList.innerHTML = `
            <div class="error-state">
              <div class="error-icon">📊</div>
              <div class="error-message">No ${this.currentView} found</div>
            </div>
          `;
          return;
        }
        
        const stocksHTML = filteredData.map(stock => {
          const isPositive = stock.change > 0;
          const changeClass = isPositive ? 'change-positive' : 'change-negative';
          const changeIcon = isPositive ? '▲' : '▼';
          
          let percentDisplay = stock.changePct;
          if (percentDisplay.includes('%')) {
            percentDisplay = percentDisplay.replace('-', '');
          }
          
          return `
            <div class="stock-card">
              <div class="stock-content">
                <div class="stock-info">
                  <div class="stock-ticker">${stock.ticker}</div>
                  <div class="stock-name">${stock.name}</div>
                </div>
                <div class="stock-metrics">
                  <div class="stock-price">₹${parseFloat(stock.ltpFormatted).toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                  })}</div>
                  <div class="stock-change ${changeClass}">
                    <span class="change-icon">${changeIcon}</span>
                    <span>${Math.abs(stock.change).toFixed(2)} (${percentDisplay})</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        stocksList.innerHTML = stocksHTML;
        
        // Reset scroll position
        document.getElementById('stocks-container').scrollTop = 0;
      }

      showUpdateIndicator() {
        const indicator = document.getElementById('update-indicator');
        indicator.classList.add('show');
        
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 3000);
      }

      showError() {
        const stocksList = document.getElementById('stocks-list');
        stocksList.innerHTML = `
          <div class="error-state">
            <div class="error-icon">⚠️</div>
            <div class="error-message">Failed to load data. Please refresh.</div>
          </div>
        `;
      }

      updateTimestamp() {
        const lastUpdated = document.getElementById('last-updated');
        const now = new Date();
        lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString('en-IN', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        })}`;
        this.lastUpdateTime = now;
      }

      startAutoRefresh() {
        // Smart refresh - only if user hasn't interacted recently
        let lastInteraction = Date.now();
        
        ['click', 'scroll', 'touchstart'].forEach(event => {
          document.addEventListener(event, () => {
            lastInteraction = Date.now();
          });
        });
        
        setInterval(() => {
          const timeSinceInteraction = Date.now() - lastInteraction;
          const timeSinceUpdate = this.lastUpdateTime ? 
            Date.now() - this.lastUpdateTime.getTime() : Infinity;
          
          // Only refresh if user hasn't interacted in 15 seconds and it's been 2+ minutes
          if (timeSinceInteraction > 15000 && timeSinceUpdate > 120000) {
            this.fetchData(true);
          }
        }, 30000);
        
        // Refresh on page visibility change
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            const timeSinceUpdate = this.lastUpdateTime ? 
              Date.now() - this.lastUpdateTime.getTime() : Infinity;
            
            if (timeSinceUpdate > 60000) { // 1 minute
              this.fetchData(true);
            }
          }
        });
      }
    }

    // Initialize the dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new ProStockDashboard();
    });
  </script>
</body>
</html>
